---
import Layout from "../../../layouts/Layout.astro";
import CommentsSection from "../../../components/CommentsSection.jsx";

// Obtener el id de los parámetros de la URL
const { id } = Astro.params;

// Función para obtener los detalles de la película
const fetchMovieDetails = async (id) => {
    let movieDetails = null;
    try {
        const response = await fetch(`http://127.0.0.1:8000/api/movie/${id}`);
        if (!response.ok) {
            console.log("Hubo un error con la petición", response.status);
        } else {
            const result = await response.json();
            console.log('Resultado de la API:', result);
            movieDetails = result.data; // Asumiendo que result.data ya es el objeto de la película
        }
    } catch (error) {
        console.error('Error en la solicitud fetch:', error);
    }
    return movieDetails;
};
/////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////
// Función para obtener los comentarios de la película
const fetchMovieComments = async (id) => {
    let comments = [];
    try {
        const response = await fetch(`http://127.0.0.1:8000/api/movie/${id}/reviews`);
        if (!response.ok) {
            console.log("Hubo un error al obtener los comentarios", response.status);
        } else {
            const result = await response.json();
            comments = result.data;
        }
    } catch (error) {
        console.error('Error en la solicitud fetch:', error);
    }
    return comments;
};


// Llamada a la función para obtener los detalles de la película Y los comentarios
const movieDetails = await fetchMovieDetails(id);
const movieComments = await fetchMovieComments(id);
console.log('Detalles de la película:', movieDetails);
---

<Layout title="Detalles">
    <div class="flex justify-end items-start h-screen pt-4">
      {movieDetails ? (
        <div class="max-w-3xl w-full mx-4 p-6 bg-gray-900 rounded-lg shadow-lg">
          <h1 class="text-3xl font-bold text-white mb-4">{movieDetails.name}</h1>
          <div class="flex items-start">
            <img src={movieDetails.image} alt={`Imagen de ${movieDetails.name}`} class="w-60 h-auto rounded mr-4" />
            <div>
              <p class="text-lg text-gray-300 mb-4">{movieDetails.synopsis} </p>
              <p class="text-sm text-gray-500 mb-4">{new Date(movieDetails.releaseDate).toLocaleDateString()}</p>
              <a id="trailer-link" href={movieDetails.urlTrailer} class="bg-zinc-200 font-medium p-2 flex gap-2 items-center" target="_blank" rel="noopener noreferrer">
                <span>Ver trailer</span>
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#000000" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                  <circle cx="12" cy="12" r="10"></circle>
                  <polygon points="10 8 16 12 10 16 10 8"></polygon>
                </svg>
              </a>
            </div>
          </div>
        </div>
      ) : (
        <div class="max-w-3xl w-full mx-4 p-6 bg-red-900 rounded-lg shadow-lg">
          <p class="text-white">Error el Alfredo le esta dando mantenimiento.</p>
          <img src="./src/img/alfredo_mantenimiento.png" alt="Imagen de Alfredo dando mantenimiento">
        </div>
      )}
      <div class="max-w-lg w-full mx-4 p-6 bg-gray-800 rounded-lg shadow-lg mt-6">
        <CommentsSection movieId={id} initialComments={movieComments} client:load />
      </div>
    </div>
</Layout>
